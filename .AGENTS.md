# AI Agent Guidelines for AnotherGlass

This document provides guidelines for AI agents working on the AnotherGlass codebase.

## Quick Start

1. **Understand the architecture**: This is a multi-module Android project with three application targets (mobile, glass-xe, glass-ee) and two library modules (shared, glass-shared).

2. **Module relationships**:
   ```
   mobile ──────────► shared
   glass-xe ────────► shared, glass-shared
   glass-ee ────────► shared, glass-shared, glass-ee-gestures
   glass-shared ────► shared
   ```

3. **Build command**: `./gradlew assemble` (or `gradlew.bat` on Windows)

## Key Directories

| Path | Purpose |
|------|---------|
| `mobile/src/main/java/com/damn/anotherglass/` | Phone companion app source |
| `glass-xe/src/main/java/com/damn/anotherglass/glass/host/` | Glass Explorer Edition source |
| `glass-ee/src/main/java/com/damn/anotherglass/glass/ee/host/` | Glass Enterprise Edition source |
| `shared/src/main/java/com/damn/anotherglass/shared/` | Shared RPC, data models |
| `glass-shared/src/main/java/com/damn/glass/shared/` | Shared Glass functionality |
| `python/` | Debug client for testing |

## Important Files

### Core Services
- `mobile/.../core/GlassService.kt` - Main mobile service (connection management, extensions)
- `mobile/.../core/BluetoothHost.java` - Bluetooth host implementation
- `mobile/.../core/WiFiHost.kt` - WiFi host implementation
- `glass-xe/.../HostService.java` - Glass XE service with LiveCard
- `glass-ee/.../core/HostService.kt` - Glass EE service
- `glass-ee/.../core/WiFiClient.kt` - WiFi client for EE

### RPC Layer
- `shared/.../rpc/RPCMessage.java` - Message container
- `shared/.../rpc/RPCHandler.java` - Message routing
- `shared/.../rpc/IMessageSerializer.java` - Serialization interface
- `shared/.../rpc/JsonMessageSerializer.java` - JSON Lines serializer
- `shared/.../rpc/ObjectMessageSerializer.java` - Java object serializer

### Data Models
- `shared/.../gps/Location.java` - GPS location data
- `shared/.../notifications/NotificationData.java` - Notification payload
- `shared/.../device/BatteryStatusData.java` - Battery status
- `shared/.../wifi/WiFiConfiguration.java` - WiFi credentials

### Extensions
- `mobile/.../extensions/GPSExtension.kt` - GPS forwarding
- `mobile/.../extensions/notifications/NotificationExtension.kt` - Notification capture
- `mobile/.../extensions/notifications/NotificationService.java` - NotificationListener

### UI (Mobile - Jetpack Compose)
- `mobile/.../ui/MainActivity.kt` - Main activity
- `mobile/.../ui/mainscreen/MainScreen.kt` - Main screen composable
- `mobile/.../ui/notifications/` - Notification filter UI

### UI (Glass EE)
- `glass-ee/.../ui/MainActivity.kt` - Main activity with ViewPager
- `glass-ee/.../ui/cards/` - Card fragments (Map, Notifications, etc.)
- `glass-ee/.../ui/menu/` - Glass menu system

## Constraints and Gotchas

### Java Version Constraints
- **glass-xe**: Must use Java 8 (GDK limitation)
- **glass-ee/mobile**: Can use Java 17

### Android SDK Constraints
- **glass-xe**: Targets API 19 (KitKat), uses Glass GDK Preview
- **glass-ee**: Min SDK 27, targets 28
- **mobile**: Min SDK 23, targets 33

### No AndroidX in glass-xe
The Glass Explorer Edition module cannot use AndroidX libraries due to API level constraints. Use support libraries or plain Android APIs only.

### Serialization Compatibility
When adding new data types to `shared/`:
1. Implement `java.io.Serializable`
2. Add `@SerializedName` annotations for JSON compatibility
3. Test with both Java object stream and JSON serialization

### EventBus Usage
Glass apps use GreenRobot EventBus for:
- Service state changes (`IService.ServiceState`)
- UI updates from background services

### LiveCard API (glass-xe only)
Glass XE uses the proprietary LiveCard API:
- `LiveCard.publish()` / `unpublish()`
- `RemoteViews` for card content
- Menu activities for card actions

### Gesture Handling (glass-ee)
Glass EE uses the gesture library from `glass-ee-gestures` submodule:
- Swipe gestures for navigation
- Tap for selection
- Two-finger swipe for special actions

## Testing Approaches

### Without Physical Glass Device
1. Use the Python debug client (`python/client.py`)
2. Set `SerializerProvider.currentSerializer` to `JSON`
3. Run: `python client.py --ui`

### Mock Location on Glass EE
```bash
adb shell appops set com.damn.anotherglass.glass.ee android:mock_location allow
```

### Debug vs Release Builds
- `glass-ee/src/debug/` and `glass-ee/src/release/` contain build-variant-specific code
- `DebugManager.kt` differs between variants

## Common Modification Patterns

### Adding a New RPC Service

1. **Define API constants** in `shared/`:
   ```java
   public class MyServiceAPI {
       public static final String ID = "MyService";
   }
   ```

2. **Define data class** in `shared/`:
   ```java
   public class MyData implements Serializable {
       @SerializedName("field")
       public String field;
   }
   ```

3. **Send from mobile** in extension:
   ```kotlin
   service.send(RPCMessage(MyServiceAPI.ID, myData))
   ```

4. **Receive on Glass** in `HostService`:
   ```kotlin
   override fun onDataReceived(data: RPCMessage) {
       when (data.service) {
           MyServiceAPI.ID -> handleMyService(data.payload as MyData)
       }
   }
   ```

### Adding UI on Mobile (Compose)

1. Create screen composable in `mobile/.../ui/`
2. Add route to `AppRoute.kt`
3. Add navigation in `MainActivity.kt`

### Adding UI Card on Glass EE

1. Create fragment in `glass-ee/.../ui/cards/`
2. Extend `BaseFragment`
3. Register in `MainActivity` ViewPager adapter

## CI/CD

GitHub Actions workflow (`.github/workflows/android_build.yml`):
- Triggers on push/PR to `master`
- Builds all modules with `./gradlew assemble`
- Uploads APKs as artifacts

## External Dependencies

### Git Submodules
```bash
git submodule update --init --recursive
```

- `externals/x-ray/` - Logging (used by mobile)
- `externals/glass-enterprise-samples/` - Gesture library (used by glass-ee)

### Key Libraries
| Library | Module | Purpose |
|---------|--------|---------|
| Jetpack Compose | mobile | UI framework |
| EventBus | mobile, glass-ee | Event communication |
| Coil | glass-ee | Image loading |
| ZXing | mobile, glass-ee | QR code generation/scanning |
| Gson | shared | JSON serialization |
| CameraX | glass-ee | Camera for QR scanning |

## Helpful Commands

```bash
# Build everything
./gradlew assemble

# Build specific module
./gradlew :mobile:assembleDebug
./gradlew :glass-ee:assembleDebug
./gradlew :glass-xe:assembleDebug

# Clean build
./gradlew clean assemble

# Install to connected device
./gradlew :mobile:installDebug
./gradlew :glass-ee:installDebug

# Check for dependency updates
./gradlew dependencyUpdates

# Run Python debug client
cd python && pip install -r requirements.txt && python client.py --ui
```
